"""
Document classification tools for agents.

These tools provide generic REST API capabilities for document classification.
The agent uses API discovery to determine endpoints and request formats.
"""
from crewai.tools import tool
from typing import Dict, Any, Optional
from pathlib import Path
from utilities import logger, config
import requests
import json


def get_classifier_api_info() -> Dict[str, Any]:
    """Get classifier API information for agent discovery."""
    return {
        "base_url": config.classifier_api_url,
        "endpoints": {
            "predict": {
                "path": "/",
                "method": "POST",
                "content_type": "multipart/form-data",
                "description": "Classify a document by uploading the file",
                "request_format": {
                    "file": "binary file data (required)",
                    "metadata": "optional metadata string"
                },
                "response_format": {
                    "predicted_class": "string - the document type",
                    "confidence": "float - confidence score 0.0-1.0",
                    "probabilities": "dict - class probabilities"
                }
            }
        },
        "timeout": config.classifier_timeout
    }


@tool("Get Classifier API Info")
def get_classifier_api_info_tool() -> Dict[str, Any]:
    """
    Get information about available classifier API endpoints.
    Use this FIRST to discover what endpoints are available and how to use them.
    
    Returns:
        Dictionary with API information including:
        - base_url: Base URL of the API
        - endpoints: Available endpoints with specifications
        - timeout: Request timeout in seconds
    """
    logger.info("Providing classifier API information")
    return get_classifier_api_info()


@tool("Make Classifier API Request")
def make_classifier_api_request(
    endpoint_path: str,
    method: str,
    file_path: str,
    additional_data: Optional[Dict[str, Any]] = None
) -> Dict[str, Any]:
    """
    Generic REST API tool for making classification requests.
    Use get_classifier_api_info_tool() first to discover available endpoints.
    
    Args:
        endpoint_path: API endpoint path (e.g., "/" for predict)
        method: HTTP method (POST, GET, etc.)
        file_path: Full path to the document file to classify
        additional_data: Optional additional form data
        
    Returns:
        Dictionary with:
        - success: Boolean
        - response: API response (if successful)
        - error: Error message (if failed)
        
    Example:
        make_classifier_api_request(
            endpoint_path="/",
            method="POST",
            file_path="/path/to/document.jpg",
            additional_data={"metadata": "document info"}
        )
    """
    api_info = get_classifier_api_info()
    base_url = api_info["base_url"]
    timeout = api_info["timeout"]
    
    url = f"{base_url}{endpoint_path}"
    file_path_obj = Path(file_path)
    
    logger.info(f"Making {method} request to {url}")
    logger.info(f"File: {file_path_obj.name}")
    
    # Validate file exists
    if not file_path_obj.exists():
        error_msg = f"File not found: {file_path}"
        logger.error(error_msg)
        return {
            "success": False,
            "error": error_msg
        }
    
    try:
        if method.upper() == "POST":
            with open(file_path_obj, 'rb') as f:
                files = {'file': (file_path_obj.name, f, 'application/octet-stream')}
                data = additional_data or {}
                
                response = requests.post(
                    url,
                    files=files,
                    data=data,
                    timeout=timeout
                )
                response.raise_for_status()
                
                result = response.json()
                logger.info(f"API request successful: {result.get('predicted_class', 'unknown')}")
                
                return {
                    "success": True,
                    "response": result
                }
        else:
            return {
                "success": False,
                "error": f"Unsupported HTTP method: {method}"
            }
            
    except requests.exceptions.RequestException as e:
        logger.error(f"API request failed: {str(e)}")
        return {
            "success": False,
            "error": str(e)
        }
    except json.JSONDecodeError as e:
        logger.error(f"Failed to parse API response: {str(e)}")
        return {
            "success": False,
            "error": f"Invalid JSON response: {str(e)}"
        }


@tool("Classify Document")
def classify_document_tool(document: Dict[str, Any]) -> Dict[str, Any]:
    """
    Classify a single document using the classifier API.
    
    Args:
        document: Document metadata object containing:
            - document_id: Unique document identifier
            - stored_path: Full path to the document file
            - original_filename: Original filename (optional)
        
    Returns:
        Dictionary with classification results including:
        - success: Boolean indicating success
        - document_id: Document identifier
        - document_type: Classified document type
        - confidence: Classification confidence score
        - categories: List of possible categories
    """
    # Extract required attributes from metadata
    document_id = document.get('document_id', 'unknown')
    stored_path = document.get('stored_path')
    original_filename = document.get('original_filename', 'unknown')
    
    logger.info(f"Classifying document: {document_id} (file: {original_filename})")
    
    # Validate required attributes
    if not stored_path:
        error_msg = f"Document {document_id} missing required 'stored_path' attribute"
        logger.error(error_msg)
        return {
            "success": False,
            "document_id": document_id,
            "error": error_msg
        }
    
    logger.info(f"Using stored_path: {stored_path}")
    
    try:
        client = get_classifier_client()
        result = client.classify_document(stored_path)
        
        logger.info(f"Classification successful for {document_id}: {result.get('predicted_class', 'unknown')}")
        
        return {
            "success": True,
            "document_id": document_id,
            "file_path": stored_path,
            "classification": result
        }
    except Exception as e:
        logger.error(f"Classification failed for {document_id}: {e}")
        return {
            "success": False,
            "document_id": document_id,
            "file_path": stored_path,
            "error": str(e)
        }





@tool("Get Classification Summary")
def get_classification_summary_tool(classification_results: List[Dict[str, Any]]) -> Dict[str, Any]:
    """
    Generate a summary of classification results.
    
    Args:
        classification_results: List of classification result dictionaries
        
    Returns:
        Dictionary with summary statistics including:
        - total_documents: Total number of documents
        - document_types: Count by document type
        - average_confidence: Average confidence score
        - success_rate: Percentage of successful classifications
    """
    logger.info("Generating classification summary")
    
    if not classification_results:
        return {
            "total_documents": 0,
            "document_types": {},
            "average_confidence": 0.0,
            "success_rate": 0.0
        }
    
    total = len(classification_results)
    successful = sum(1 for r in classification_results if r.get('success', False))
    
    # Count document types
    document_types = {}
    total_confidence = 0.0
    confidence_count = 0
    
    for result in classification_results:
        if result.get('success') and 'classification' in result:
            classification = result['classification']
            
            # Count document type
            doc_type = classification.get('document_type', 'unknown')
            document_types[doc_type] = document_types.get(doc_type, 0) + 1
            
            # Sum confidence
            if 'confidence' in classification:
                total_confidence += classification['confidence']
                confidence_count += 1
    
    avg_confidence = total_confidence / confidence_count if confidence_count > 0 else 0.0
    success_rate = (successful / total * 100) if total > 0 else 0.0
    
    return {
        "total_documents": total,
        "successful": successful,
        "failed": total - successful,
        "document_types": document_types,
        "average_confidence": round(avg_confidence, 2),
        "success_rate": round(success_rate, 2)
    }
