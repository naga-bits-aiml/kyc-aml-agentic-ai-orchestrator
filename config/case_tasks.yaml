# Case Management Task Definitions
# Tasks for orchestrating document processing and generating case summaries

orchestrate_case_processing_task:
  description: >
    Orchestrate processing of all documents in case {case_id}.
    
    This task coordinates the document processing workflow:
    
    STEP 1: DISCOVER & LINK DOCUMENTS
    - Review the current list of documents in the case: {documents}
    - If the list is empty or seems incomplete, proactively search for unlinked documents:
      * Look for recently processed documents in intake/classification/extraction stages
      * Check document metadata for relevant identifiers (customer name, date range, etc.)
      * Suggest linking candidates to the user: "Found DOC_XXX (Passport) - should I link to this case?"
    - Use link_document_to_case_tool to link documents when appropriate
    
    STEP 2: VERIFY PROCESSING STATUS (ONCE PER DOCUMENT)
    - For EACH UNIQUE document in the case (iterate once only):
      * Use get_document_by_id_tool to check current metadata
      * Review: intake.status, classification.status, extraction.status
      * Track which stages are complete vs failed
    - DO NOT process the same document multiple times in this step
    
    STEP 3: IDENTIFY INCOMPLETE WORK
    - Create a list of documents with failed/pending stages
    - Note: If ALL stages are successful, skip to STEP 4
    - If any stages failed, note them for user notification (do NOT auto-reprocess)
    
    STEP 4: REPORT STATUS
    - Summarize processing status for all documents
    - List any documents needing attention
    - Return processing_complete=true only if ALL documents have ALL stages successful
    
    CRITICAL RULES:
    - Process each document ID ONCE in status check
    - Do NOT trigger automatic reprocessing (user decides)
    - Do NOT call document processing crew from this task
    - Your role is COORDINATION not EXECUTION
    
  expected_output: >
    JSON with orchestration results:
    {
      "case_id": "KYC-2026-001",
      "total_documents": 3,
      "processing_complete": true/false,
      "documents_status": [
        {"document_id": "DOC_123", "status": "complete", "stages": {"intake": "success", "classification": "success", "extraction": "success"}},
        {"document_id": "DOC_456", "status": "failed", "stages": {"intake": "success", "classification": "success", "extraction": "fail"}}
      ],
      "ready_for_summary": true/false
    }
  
  agent: case_orchestrator_agent

generate_case_summary_task:
  description: >
    Generate comprehensive case summary for case {case_id} by aggregating document data.
    
    STEP 1: Call generate_case_summary_tool(case_id="{case_id}")
    
    The tool will:
    - Load all document metadata from the case
    - Group documents by classification category:
      * id_proof: Passports, driver's licenses, national IDs
      * address_proof: Utility bills, bank statements, rental agreements
      * financial_statement: Bank statements, tax returns, financial documents
    - Extract key fields for each category:
      * ID Proof: name, dob, document_number, expiry_date, issuing_authority
      * Address Proof: name, address, date, issuing_organization
      * Financial: name, account_number, statement_date, balance
    - Perform consistency checks (name matching, address verification)
    - Determine overall verification status
    
    STEP 2: Call update_case_summary_tool(case_id="{case_id}", case_summary=<result from step 1>)
    
    This saves the summary to case metadata.
    
    STEP 3: Return the generated summary with verification status and any inconsistencies found.
    
  expected_output: >
    JSON with complete case summary:
    {
      "case_id": "KYC-2026-001",
      "case_summary": {
        "id_proof": {
          "documents": ["DOC_123"],
          "verified": true,
          "extracted_data": {
            "name": "John Doe",
            "dob": "1990-01-01",
            "document_number": "A12345678",
            "expiry_date": "2030-01-01",
            "issuing_authority": "Government..."
          }
        },
        "address_proof": {
          "documents": ["DOC_456"],
          "verified": true,
          "extracted_data": {
            "name": "John Doe",
            "address": "123 Main St, City",
            "date": "2025-12-01",
            "issuing_organization": "Utility Co"
          }
        },
        "financial_statement": {
          "documents": [],
          "verified": false,
          "extracted_data": {}
        },
        "verification_status": "partial",
        "consistency_checks": {
          "name_consistency": {"status": "consistent", "name": "John Doe"},
          "address_consistency": {"status": "consistent"}
        },
        "generated_at": "2026-01-28T10:00:00"
      }
    }
  
  agent: case_summarizer_agent
